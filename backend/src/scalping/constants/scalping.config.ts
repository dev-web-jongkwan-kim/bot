/**
 * 스캘핑 전략 설정
 *
 * 이 설정들은 백테스트와 실전 테스트를 통해 조정해야 합니다.
 * 각 값의 의미와 권장 범위를 주석으로 설명합니다.
 *
 * @version 1.0.0
 * @description 30분 이내 청산 초단타 스캘핑 전략 파라미터
 */
export const SCALPING_CONFIG = {
  // ============================================
  // 전략 활성화 설정
  // ============================================
  strategy: {
    /**
     * SimpleTrueOB 전략 비활성화
     *
     * - true: SimpleTrueOB 비활성화 (스캘핑만 사용)
     * - false: SimpleTrueOB도 함께 실행
     */
    disableSimpleTrueOB: true,
  },

  // ============================================
  // 스캔 설정
  // ============================================
  scan: {
    /**
     * 스캔 주기 (밀리초)
     * - 1분(60000ms)마다 전체 종목 스캔
     * - 너무 짧으면 CPU 부하, 너무 길면 기회 놓침
     * @range 30000 - 120000
     */
    intervalMs: 60000,

    /**
     * 모니터링 종목 수
     * - OKX USDT 무기한 선물 전체
     * @range 50 - 200
     */
    maxSymbols: 140,
  },

  // ============================================
  // 1차 필터: 거시적 조건
  // ============================================
  filter1: {
    /**
     * Funding Rate 필터
     *
     * 롱 진입 시: Funding < maxForLong (0.05% = 0.0005)
     * - 높은 Funding = 롱 과열 = 롱 위험
     * - 0.05% 이상이면 롱 진입 금지
     *
     * 숏 진입 시: Funding > minForShort (0.03% = 0.0003)
     * - 낮은 Funding = 숏 과열 = 숏 위험
     * - 0.03% 이하면 숏 진입 금지
     *
     * 극단값에서는 역방향만 허용:
     * - Funding > 0.1%: 숏만 허용
     * - Funding < -0.1%: 롱만 허용
     */
    funding: {
      /** 롱 진입 한도 @range 0.0003 - 0.001 */
      maxForLong: 0.0005, // 0.05%
      /** 숏 진입 한도 @range 0.0001 - 0.0005 */
      minForShort: 0.0003, // 0.03%
      /** 극단적 롱 과열 @range 0.0008 - 0.002 */
      extremeHigh: 0.001, // 0.1%
      /** 극단적 숏 과열 @range -0.002 - -0.0008 */
      extremeLow: -0.001, // -0.1%
    },

    /**
     * 스프레드 필터
     *
     * 스프레드 = (ask - bid) / mid_price
     * - 0.05% 이상이면 슬리피지 위험으로 제외
     * - BTC/ETH는 보통 0.01% 미만
     * - 소형 알트는 0.1% 이상일 수 있음
     * @range 0.0003 - 0.001
     */
    maxSpreadPercent: 0.001, // 0.1% (완화: 0.05% → 0.1%)

    /**
     * 24시간 거래량 필터
     *
     * 하위 N% 거래량 종목 제외
     * - 유동성 부족 = 체결 어려움 + 슬리피지
     * @range 0.1 - 0.3
     */
    minVolumeRank: 0.2, // 하위 20% 제외
  },

  // ============================================
  // 2차 필터: 15분봉 추세
  // ============================================
  filter2: {
    /**
     * 고저점 비교 봉 수
     *
     * 최근 N개 봉의 고점/저점 구조로 추세 판단
     * - 4개 = 최근 1시간
     * @range 3 - 6
     */
    trendBars: 4,

    /**
     * OI 변화율 임계값
     *
     * OI 증가 = 신규 포지션 진입 (추세 강화)
     * OI 감소 = 포지션 청산 (추세 약화)
     * - 1% 이상 증가를 "신규 진입"으로 판단
     * @range 0.005 - 0.02
     */
    oiChangeThreshold: 0.01, // 1%
  },

  // ============================================
  // 3차 필터: 5분봉 모멘텀
  // ============================================
  filter3: {
    /**
     * 모멘텀 분석 봉 수
     *
     * 최근 N개 5분봉으로 모멘텀 상태 판단
     * - 5개 = 최근 25분
     * @range 3 - 7
     */
    momentumBars: 5,

    /**
     * 봉 크기 비율 임계값
     *
     * 마지막 봉 크기 / 평균 봉 크기
     * - < exhausted = 소진 (EXHAUSTED)
     * - > momentum = 모멘텀 진행 중 (MOMENTUM)
     * - exhausted ~ momentum = 풀백 (PULLBACK) ← 진입 기회
     */
    bodySizeRatio: {
      /** 소진 기준 @range 0.3 - 0.6 */
      exhausted: 0.5,
      /** 모멘텀 기준 @range 0.7 - 1.0 */
      momentum: 0.8,
    },

    /**
     * 거래량 감소 임계값
     *
     * 마지막 봉 거래량 / 평균 거래량
     * - 이 미만이면 거래량 감소 = 소진 신호
     * @range 0.5 - 0.8
     */
    volumeDecreaseRatio: 0.7,

    /**
     * CVD 분석 봉 수
     *
     * 최근 N개 봉의 CVD 합산
     * - 양수 = 매수 체결 우세
     * - 음수 = 매도 체결 우세
     * @range 2 - 5
     */
    cvdBars: 3,
  },

  // ============================================
  // 주문 설정
  // ============================================
  order: {
    /**
     * 진입 오프셋 (ATR 배수)
     *
     * Limit 주문 가격 = 현재가 ± (ATR × offset)
     * - 0.15 = ATR의 15% 정도 유리하게 진입 시도
     * - 너무 크면 체결 안 됨, 너무 작으면 의미 없음
     * @range 0.1 - 0.25
     */
    entryOffsetAtr: 0.15,

    /**
     * TP (Take Profit) 거리 (ATR 배수)
     *
     * TP 가격 = 진입가 ± (ATR × tpAtr)
     * - 0.8 = ATR의 80%
     * - TP:SL = 1:1 비율
     * @range 0.4 - 1.0
     */
    tpAtr: 0.8,

    /**
     * SL (Stop Loss) 거리 (ATR 배수)
     *
     * SL 가격 = 진입가 ∓ (ATR × slAtr)
     * - 0.8 = ATR의 80%
     * - TP:SL = 1:1 비율 (넓은 범위)
     * @range 0.2 - 1.0
     */
    slAtr: 0.8,

    /**
     * ATR 계산 기간
     *
     * 최근 N개 봉의 ATR 평균
     * @range 10 - 20
     */
    atrPeriod: 14,

    /**
     * 미체결 타임아웃 (초)
     *
     * Limit 주문 후 N초 내 체결 안 되면 취소
     * - 300초 = 5분
     * @range 180 - 600
     */
    unfillTimeoutSec: 300,
  },

  // ============================================
  // 포지션 관리
  // ============================================
  position: {
    /**
     * 최대 보유 시간 (초)
     *
     * 30분 = 1800초
     * - 이 시간 초과 시 무조건 시장가 청산
     * @range 1200 - 3600
     */
    maxHoldTimeSec: 1800,

    /**
     * TP 축소 시작 시간 (초)
     *
     * 20분 = 1200초
     * - 이 시간 이후 TP를 축소
     * @range 600 - 1500
     */
    tpReduceTimeSec: 1200,

    /**
     * TP 축소 비율
     *
     * 0.5 = 50%로 축소
     * - 원래 TP가 0.3%였다면 0.15%로
     * @range 0.3 - 0.7
     */
    tpReduceRatio: 0.5,

    /**
     * 본전 청산 시작 시간 (초)
     *
     * 25분 = 1500초
     * - 이 시간 이후 본전 이상이면 청산
     * @range 1200 - 1800
     */
    breakevenTimeSec: 1500,
  },

  // ============================================
  // 리스크 관리
  // ============================================
  risk: {
    /**
     * 동시 최대 포지션 수
     *
     * - 이 수 초과 시 신규 진입 금지
     * - 리스크 분산 목적
     * @range 3 - 20
     */
    maxPositions: 20,

    /**
     * 동일 방향 최대 포지션 수
     *
     * - 롱 N개 이상이면 추가 롱 금지
     * - 숏 N개 이상이면 추가 숏 금지
     * - 방향 편중 방지
     * @range 2 - 10
     */
    maxSameDirection: 10,

    /**
     * 거래당 리스크 비율
     *
     * - 계좌의 N%를 1회 거래에 리스크
     * @range 0.003 - 0.01
     */
    riskPerTrade: 0.005, // 0.5%

    /**
     * 일일 최대 손실
     *
     * - 당일 손실이 N% 초과 시 거래 중단
     * - 1.0 = 100% (사실상 비활성화)
     * @range 0.01 - 1.0
     */
    maxDailyLoss: 1.0, // 100% (비활성화)

    /**
     * 연속 손실 후 휴식
     *
     * - 연속 N회 손실 시 휴식
     * @range 2 - 5
     */
    consecutiveLossLimit: 3,

    /**
     * 쿨다운 시간 (분)
     *
     * - 연속 손실 후 휴식 시간
     * @range 15 - 60
     */
    cooldownMinutes: 30,

    /**
     * 레버리지 (우선순위: 15 → 10 → 5)
     *
     * - 고정 레버리지 목표값
     * - OKX에서 지원하지 않으면 자동 폴백
     * @range 5 - 15
     */
    leverage: 15,

    /**
     * 레버리지 폴백 목록
     *
     * - 첫 번째가 안되면 다음으로 시도
     */
    leverageFallback: [15, 10, 5],

    /**
     * 거래당 고정 마진 (USDT)
     *
     * - 포지션 크기 계산에 사용
     * - 0이면 riskPerTrade 기반 동적 계산
     * @range 10 - 100
     */
    fixedMarginUsdt: 15,
  },

  // ============================================
  // 로깅 설정
  // ============================================
  logging: {
    /**
     * 상세 로깅 활성화
     *
     * - true: 모든 단계 상세 로그
     * - false: 주요 이벤트만 로그
     */
    verbose: true,

    /**
     * 필터 통과/실패 로깅
     *
     * - true: 모든 심볼의 필터 결과 로그
     * - false: 통과한 심볼만 로그
     */
    logFilterResults: true,

    /**
     * 시그널 요약 주기 (분)
     *
     * - N분마다 시그널 요약 출력
     * @range 1 - 10
     */
    summaryIntervalMinutes: 5,
  },
};

/**
 * 설정 타입 정의
 */
export type ScalpingConfig = typeof SCALPING_CONFIG;

/**
 * 종목별 ATR 기준값 (참고용)
 *
 * 실제로는 실시간 계산해야 하지만,
 * 대략적인 기준으로 사용 가능
 */
export const SYMBOL_ATR_REFERENCE: Record<
  string,
  { typical5mAtrPercent: number }
> = {
  BTC: { typical5mAtrPercent: 0.15 }, // 0.15%
  ETH: { typical5mAtrPercent: 0.25 }, // 0.25%
  SOL: { typical5mAtrPercent: 0.4 }, // 0.40%
  XRP: { typical5mAtrPercent: 0.35 }, // 0.35%
  DOGE: { typical5mAtrPercent: 0.45 }, // 0.45%
  // 소형 알트는 0.5~1.0% 범위
};
